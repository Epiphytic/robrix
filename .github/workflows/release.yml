# Robrix Release CI Workflow
#
# RUNNER COST NOTES:
# ==================
# - Standard runners (ubuntu-latest, macos-*, windows-*): included in free tier
# - ARM runners (ubuntu-*-arm): LARGER RUNNERS - cost $0.016/minute (10x standard)
#
# To avoid large runner costs:
# 1. Use "All-x86_64-only" option for most releases (skips ARM Linux builds)
# 2. Use self-hosted runners for ARM builds (set use_self_hosted_for_arm=true)
# 3. Configure self-hosted runners with: ./scripts/setup-self-hosted-runner.sh
#
# Self-hosted runner requirements:
# - Linux ARM64 machine (e.g., Raspberry Pi 4+, AWS Graviton, Apple M1 via Docker)
# - Runner configured with labels: self-hosted,robrix,linux,arm64
# - See scripts/setup-self-hosted-runner.sh for setup instructions

name: Robrix Release CI

on:
  push:
    tags:
      - 'v*.*.*'    # Release Version Tags
      - 'v*.*.*-*'  # Pre-release Version Tags
  workflow_dispatch:
    inputs:
      target_platforms:
        description: 'Target platforms for the release'
        required: true
        type: choice
        options:
          - 'All'                         # Build for all platforms
          - 'All-x86_64-only'             # Build for all x86_64 platforms (no ARM, cheaper)
          - 'linux-ubuntu-24.04'          # Build for Ubuntu 24.04 both x86_64 and aarch64
          - 'linux-ubuntu-24.04-x86_64'   # Build for Ubuntu 24.04 x86_64
          - 'linux-ubuntu-24.04-aarch64'  # Build for Ubuntu 24.04 aarch64 (self-hosted or larger runner)
          - 'linux-ubuntu-22.04'          # Build for Ubuntu 22.04 both x86_64 and aarch64
          - 'linux-ubuntu-22.04-x86_64'   # Build for Ubuntu 22.04 x86_64
          - 'linux-ubuntu-22.04-aarch64'  # Build for Ubuntu 22.04 aarch64 (self-hosted or larger runner)
          - 'macos-14-aarch64'            # Build for MacOS 14 (Apple Silicon)
          - 'macos-15-x86_64'             # Build for MacOS 15 (Intel)
          - 'windows-2022-x86_64'         # Build for Windows 2022 x86_64
      release_tag:
        description: 'Release tag (required if creating release)'
        required: false
        type: string
        default: ''
      create_release:
        description: 'Create a GitHub Release'
        required: true
        type: boolean
        default: false
      pre_release:
        description: 'Mark as a pre-release'
        required: true
        type: boolean
        default: false
      use_self_hosted_for_arm:
        description: 'Use self-hosted runners for ARM builds (requires configured runner with labels: self-hosted,robrix,linux,arm64)'
        required: false
        type: boolean
        default: true

permissions: write-all
env:
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: short

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  check_tag_version:
    name: Check Release Tag and Cargo.toml Version Consistency
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Check tag and Cargo.toml version
        run: |
          TAG_REF="${GITHUB_REF##*/}"
          echo "Current tag: $TAG_REF"

          CARGO_MANIFEST_VERSION=$(cargo metadata --no-deps --format-version 1 --frozen | jq -r '.packages[0].version')
          echo "Cargo.toml Robrix version: $CARGO_MANIFEST_VERSION"

          if [[ "$TAG_REF" != "v$CARGO_MANIFEST_VERSION" ]]; then
            echo "Error: Tag '$TAG_REF' does not match Cargo.toml version '$CARGO_MANIFEST_VERSION'."
            echo "Please create a tag that matches the Cargo.toml version."
            exit 1
          else
            echo "Tag and Cargo.toml version are consistent."
          fi

  determine_matrix:
    name: Determine Build Matrix
    runs-on: ubuntu-latest
    if: always() && (needs.check_tag_version.result == 'success' || github.event_name == 'workflow_dispatch')
    needs: check_tag_version
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set build matrix
        id: set-matrix
        env:
          TARGET_PLATFORMS: ${{ github.event.inputs.target_platforms }}
          USE_SELF_HOSTED: ${{ github.event.inputs.use_self_hosted_for_arm }}
        run: |
          # Determine ARM runner type based on self-hosted preference
          # Default (true): use self-hosted runners with labels: [self-hosted, robrix, linux, arm64]
          # When false: use GitHub-hosted ARM runners (ubuntu-*-arm) which are LARGER RUNNERS and cost $0.016/min
          # Note: For self-hosted runners, we use JSON array format for multiple labels
          if [[ "$USE_SELF_HOSTED" != "false" ]]; then
            # Self-hosted runners (default) - configure with: ./scripts/setup-self-hosted-runner.sh
            ARM_RUNNER='["self-hosted","robrix","linux","arm64"]'
          else
            # WARNING: These are larger runners and cost significantly more than standard runners ($0.016/min)
            ARM_RUNNER='"ubuntu-22.04-arm"'
          fi

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            case "$TARGET_PLATFORMS" in
              "All")
                matrix="{\"include\":[{\"os\":\"ubuntu-24.04\",\"arch\":\"x86_64\"},{\"os\":${ARM_RUNNER},\"arch\":\"aarch64\"},{\"os\":\"ubuntu-22.04\",\"arch\":\"x86_64\"},{\"os\":${ARM_RUNNER},\"arch\":\"aarch64\"},{\"os\":\"macos-14\",\"arch\":\"aarch64\"},{\"os\":\"macos-15-intel\",\"arch\":\"x86_64\"},{\"os\":\"windows-2022\",\"arch\":\"x86_64\"}]}"
                ;;
              "All-x86_64-only")
                # Cost-effective option: skip ARM Linux builds entirely, use standard runners only
                matrix='{"include":[{"os":"ubuntu-24.04","arch":"x86_64"},{"os":"ubuntu-22.04","arch":"x86_64"},{"os":"macos-14","arch":"aarch64"},{"os":"macos-15-intel","arch":"x86_64"},{"os":"windows-2022","arch":"x86_64"}]}'
                ;;
              "linux-ubuntu-24.04")
                matrix="{\"include\":[{\"os\":\"ubuntu-24.04\",\"arch\":\"x86_64\"},{\"os\":${ARM_RUNNER},\"arch\":\"aarch64\"}]}"
                ;;
              "linux-ubuntu-24.04-x86_64")
                matrix='{"include":[{"os":"ubuntu-24.04","arch":"x86_64"}]}'
                ;;
              "linux-ubuntu-24.04-aarch64")
                matrix="{\"include\":[{\"os\":${ARM_RUNNER},\"arch\":\"aarch64\"}]}"
                ;;
              "linux-ubuntu-22.04")
                matrix="{\"include\":[{\"os\":\"ubuntu-22.04\",\"arch\":\"x86_64\"},{\"os\":${ARM_RUNNER},\"arch\":\"aarch64\"}]}"
                ;;
              "linux-ubuntu-22.04-x86_64")
                matrix='{"include":[{"os":"ubuntu-22.04","arch":"x86_64"}]}'
                ;;
              "linux-ubuntu-22.04-aarch64")
                matrix="{\"include\":[{\"os\":${ARM_RUNNER},\"arch\":\"aarch64\"}]}"
                ;;
              "macos-14-aarch64")
                matrix='{"include":[{"os":"macos-14","arch":"aarch64"}]}'
                ;;
              "macos-15-x86_64")
                matrix='{"include":[{"os":"macos-15-intel","arch":"x86_64"}]}'
                ;;
              "windows-2022-x86_64")
                matrix='{"include":[{"os":"windows-2022","arch":"x86_64"}]}'
                ;;
            esac
          else
            # Tag-triggered releases: x86_64 only for Linux (no ARM builds)
            # macOS includes both Intel (x86_64) and Apple Silicon (aarch64)
            matrix='{"include":[{"os":"ubuntu-24.04","arch":"x86_64"},{"os":"ubuntu-22.04","arch":"x86_64"},{"os":"macos-14","arch":"aarch64"},{"os":"macos-15-intel","arch":"x86_64"},{"os":"windows-2022","arch":"x86_64"}]}'
          fi
          echo "matrix=$matrix" >> $GITHUB_OUTPUT

  release_robrix_for_desktop:
    name: Release Robrix for Desktop (${{ matrix.os }}, ${{ matrix.arch }})
    needs: determine_matrix
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.determine_matrix.outputs.matrix) }}
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Linux necessary dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libssl-dev \
            libsqlite3-dev \
            pkg-config \
            llvm \
            clang \
            libclang-dev \
            binfmt-support \
            libxcursor-dev \
            libx11-dev \
            libasound2-dev \
            libpulse-dev \
            libwayland-dev libxkbcommon-dev

      - name: Install Rust Stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-packager
        run: |
          cargo +stable install --force --locked cargo-packager

      - name: Install robius-packaging-commands
        run: |
          cargo install --version 0.2.0 --locked --git https://github.com/project-robius/robius-packaging-commands.git robius-packaging-commands

      - name: Build
        shell: bash
        run: |
          cargo packager --release
          ls ./dist

      - name: Sign macOS App
        if: runner.os == 'macOS'
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
          MACOS_KEYCHAIN_PWD: ${{ secrets.MACOS_KEYCHAIN_PWD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PWD: ${{ secrets.APPLE_ID_PWD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          DMG_FILE=$(find ./dist -name "*.dmg" | head -1)
          if [ -z "$DMG_FILE" ]; then
            echo "No DMG file found, skipping signing"
            exit 0
          fi

          # Determine signing identity based on available secrets
          if [ -n "$MACOS_CERTIFICATE" ] && [ -n "$MACOS_CERTIFICATE_PWD" ] && [ -n "$MACOS_KEYCHAIN_PWD" ]; then
            echo "Developer ID certificate available - using Developer ID signing"
            USE_DEVELOPER_ID=true

            # Create and configure keychain
            KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
            security create-keychain -p "$MACOS_KEYCHAIN_PWD" $KEYCHAIN_PATH
            security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
            security unlock-keychain -p "$MACOS_KEYCHAIN_PWD" $KEYCHAIN_PATH

            # Import certificate
            echo "$MACOS_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/certificate.p12
            security import $RUNNER_TEMP/certificate.p12 -P "$MACOS_CERTIFICATE_PWD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
            security list-keychain -d user -s $KEYCHAIN_PATH
            security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$MACOS_KEYCHAIN_PWD" $KEYCHAIN_PATH

            SIGN_IDENTITY="Developer ID Application"
          else
            echo "No Developer ID certificate - using ad-hoc signing (local devices only)"
            USE_DEVELOPER_ID=false
            SIGN_IDENTITY="-"
          fi

          echo "Signing DMG: $DMG_FILE"

          # Mount the DMG
          MOUNT_POINT=$RUNNER_TEMP/dmg_mount
          mkdir -p $MOUNT_POINT
          hdiutil attach "$DMG_FILE" -mountpoint $MOUNT_POINT -nobrowse

          # Find and sign the app
          APP_PATH=$(find $MOUNT_POINT -name "*.app" -maxdepth 1 | head -1)
          if [ -n "$APP_PATH" ]; then
            # Create a writable copy
            TEMP_APP=$RUNNER_TEMP/Robrix.app
            cp -R "$APP_PATH" "$TEMP_APP"
            hdiutil detach $MOUNT_POINT

            # Sign the app
            if [ "$USE_DEVELOPER_ID" = true ]; then
              codesign --force --deep --sign "$SIGN_IDENTITY" "$TEMP_APP" --options runtime
            else
              codesign --force --deep --sign "$SIGN_IDENTITY" "$TEMP_APP"
            fi

            # Create a new signed DMG
            SIGNED_DMG="${DMG_FILE%.dmg}-signed.dmg"
            hdiutil create -volname "Robrix" -srcfolder "$TEMP_APP" -ov -format UDZO "$SIGNED_DMG"

            # Sign the DMG itself (only for Developer ID)
            if [ "$USE_DEVELOPER_ID" = true ]; then
              codesign --force --sign "$SIGN_IDENTITY" "$SIGNED_DMG"
            fi

            # Replace original with signed version
            mv "$SIGNED_DMG" "$DMG_FILE"

            # Notarize (only if Developer ID and Apple credentials available)
            if [ "$USE_DEVELOPER_ID" = true ] && [ -n "$APPLE_ID" ] && [ -n "$APPLE_ID_PWD" ] && [ -n "$APPLE_TEAM_ID" ]; then
              echo "Notarizing..."
              xcrun notarytool submit "$DMG_FILE" --apple-id "$APPLE_ID" --password "$APPLE_ID_PWD" --team-id "$APPLE_TEAM_ID" --wait || echo "Notarization failed, continuing..."
              xcrun stapler staple "$DMG_FILE" || echo "Stapling failed, continuing..."
            fi

            echo "Signing complete"
          else
            hdiutil detach $MOUNT_POINT
            echo "No app found in DMG"
          fi

          # Cleanup
          if [ "$USE_DEVELOPER_ID" = true ]; then
            rm -f $RUNNER_TEMP/certificate.p12
            security delete-keychain $KEYCHAIN_PATH 2>/dev/null || true
          fi

      - name: Set Version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.release_tag }}" ]]; then
            VERSION="${{ github.event.inputs.release_tag }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          else
            VERSION=$(cargo metadata --no-deps --format-version 1 --frozen | jq -r '.packages[0].version')
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
        shell: bash

      - name: Set Artifact and Upload Paths
        shell: bash
        env:
          RUNNER_OS: ${{ runner.os }}
        run: |
          VERSION=${{ env.VERSION }}
          ARCH=${{ matrix.arch }}

          # Use runner.os for OS detection (works for both GitHub-hosted and self-hosted runners)
          # Use matrix.arch for architecture detection
          if [[ "$RUNNER_OS" == "Linux" && "$ARCH" == "x86_64" ]]; then
            {
              echo "DEB=robrix_${VERSION}_amd64.deb"
              echo "APPIMAGE=robrix_${VERSION}_x86_64.AppImage"
              echo "TAR=robrix_${VERSION}_x86_64.tar.gz"
              echo "UPLOAD_FILES<<EOF"
              echo "./dist/robrix_${VERSION}_amd64.deb"
              echo "./dist/robrix_${VERSION}_x86_64.AppImage"
              echo "./dist/robrix_${VERSION}_x86_64.tar.gz"
              echo "EOF"
            } >> $GITHUB_ENV

          elif [[ "$RUNNER_OS" == "Linux" && "$ARCH" == "aarch64" ]]; then
            {
              echo "DEB=robrix_${VERSION}_arm64.deb"
              echo "APPIMAGE=robrix_${VERSION}_aarch64.AppImage"
              echo "TAR=robrix_${VERSION}_aarch64.tar.gz"
              echo "UPLOAD_FILES<<EOF"
              echo "./dist/robrix_${VERSION}_arm64.deb"
              echo "./dist/robrix_${VERSION}_aarch64.AppImage"
              echo "./dist/robrix_${VERSION}_aarch64.tar.gz"
              echo "EOF"
            } >> $GITHUB_ENV

          elif [[ "$RUNNER_OS" == "macOS" && "$ARCH" == "aarch64" ]]; then
            FILE="robrix-${VERSION}-macOS-${ARCH}.dmg"
            mv ./dist/Robrix_${VERSION}_aarch64.dmg ./dist/$FILE
            echo "RELEASE_FILE=$FILE" >> $GITHUB_ENV
            echo "UPLOAD_FILES=./dist/$FILE" >> $GITHUB_ENV

          elif [[ "$RUNNER_OS" == "macOS" && "$ARCH" == "x86_64" ]]; then
            FILE="robrix-${VERSION}-macOS-${ARCH}.dmg"
            mv ./dist/Robrix_${VERSION}_x64.dmg ./dist/$FILE
            echo "RELEASE_FILE=$FILE" >> $GITHUB_ENV
            echo "UPLOAD_FILES=./dist/$FILE" >> $GITHUB_ENV

          elif [[ "$RUNNER_OS" == "Windows" ]]; then
            FILE="robrix-${VERSION}-windows-${ARCH}-setup.exe"
            mv ./dist/robrix_${VERSION}_x64-setup.exe ./dist/$FILE
            echo "RELEASE_FILE=$FILE" >> $GITHUB_ENV
            echo "UPLOAD_FILES=./dist/$FILE" >> $GITHUB_ENV
          fi

      - name: Upload Release Artifacts
        if: |
          (github.event_name == 'push') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_tag || format('v{0}', env.VERSION) }}
          name: ${{ github.event_name == 'workflow_dispatch' && format('Robrix {0}', github.event.inputs.release_tag) || format('Robrix v{0}', env.VERSION) }}
          token: ${{ secrets.ROBRIX_RELEASE }}
          files: ${{ env.UPLOAD_FILES }}
          prerelease: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.pre_release == 'true' || contains(github.ref, '-') }}
          draft: ${{ github.event_name == 'workflow_dispatch' }}

      - name: Upload Artifacts (No Release)
        if: |
          github.event_name == 'workflow_dispatch' && github.event.inputs.create_release != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: robrix-${{ env.VERSION }}-${{ runner.os }}-${{ matrix.arch }}
          path: ${{ env.UPLOAD_FILES }}
          retention-days: 30